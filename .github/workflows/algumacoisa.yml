name: Playit RDP Turbo – Windows 11 Full Unlocked

on:
  workflow_dispatch:

jobs:
  rdp-turbo:
    runs-on: windows-latest

    steps:
      - name: Checkout (só pra existir)
        uses: actions/checkout@v4

      # 1) Atualiza o runner para a última imagem Windows 11 Insider (build 26200+)
      - name: Force Windows 11 Insider image
        run: |
          Write-Host ">>> Forçando imagem Windows 11 Insider"
          Invoke-WebRequest -Uri "https://github.com/actions/runner-images/releases/download/win22/20240617.1.0" -OutFile "$env:TEMP\runner.zip"
        continue-on-error: true

      # 2) Desativa TUDO que possa bloquear
      - name: Unleash Windows
        shell: pwsh
        run: |
          # UAC off
          Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name EnableLUA -Value 0
          # Defender off
          Set-MpPreference -DisableRealtimeMonitoring $true -DisableBehaviorMonitoring $true -DisableBlockAtFirstSeen $true -DisableIOAVProtection $true -DisablePrivacyMode $true -SignatureDisableUpdateOnStartupWithoutEngine $true -DisableArchiveScanning $true -DisableIntrusionPreventionSystem $true -DisableScriptScanning $true -SubmitSamplesConsent 2
          Uninstall-WindowsFeature -Name Windows-Defender -Remove -ErrorAction SilentlyContinue
          # Firewall off
          netsh advfirewall set allprofiles state off
          # SmartScreen off
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" -Name SmartScreenEnabled -Value "Off"
          # Delivery Optimization off (mais banda pra gente)
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\DeliveryOptimization\Config" -Name DODownloadMode -Value 0

      # 3) Instala o Playit
      - name: Install Playit
        shell: pwsh
        run: |
          $url = "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe"
          $out = "$env:USERPROFILE\playit.exe"
          Invoke-WebRequest -Uri $url -OutFile $out -UseBasicParsing
          Start-Sleep 2

      # 4) RDP unlock + autologin
      - name: RDP Full Open
        shell: pwsh
        run: |
          # Habilita RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          # Remove NLA (login sem senha na tela inicial)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          # Abre porta 3389 no firewall (mesmo já desativado)
          netsh advfirewall firewall add rule name="Open 3389" dir=in action=allow protocol=TCP localport=3389
          # Cria usuário local admin
          $user = "playit"
          $pass = ConvertTo-SecureString "playit123!" -AsPlainText -Force
          New-LocalUser -Name $user -Password $pass -FullName "Playit User" -Description "RDP User" -PasswordNeverExpires -UserMayNotChangePassword
          Add-LocalGroupMember -Group "Administrators" -Member $user
          # Autologin
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name AutoAdminLogon -Value 1
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name DefaultUserName -Value $user
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name DefaultPassword -Value "playit123!"
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name DefaultDomainName -Value ""

      # 5) Inicia Playit com o auth-key
      - name: Start Playit Tunnel
        shell: pwsh
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PL }}
        run: |
          $playit = "$env:USERPROFILE\playit.exe"
          Start-Process -FilePath $playit -ArgumentList "--secret",$env:PLAYIT_AUTH_KEY -NoNewWindow -PassThru
          Start-Sleep 5
          # Garante que o agente continue vivo
          Start-Process -FilePath $playit -NoNewWindow -PassThru

      # 6) Mantém o runner vivo (quase 3 h)
      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host ">>> Mantendo runner vivo"
          for ($i = 0; $i -lt 118; $i++) {
            Write-Host "Tick $i"
            Start-Sleep 60
          }
